import { NextRequest, NextResponse } from 'next/server'; import Stripe from 'stripe'; import { createClient } from '@supabase/supabase-js'; export async function POST(req:NextRequest){ const key=process.env.STRIPE_SECRET_KEY; const secret=process.env.STRIPE_WEBHOOK_SECRET; const url=process.env.NEXT_PUBLIC_SUPABASE_URL; const k=process.env.SUPABASE_SERVICE_ROLE; if(!key||!secret||!url||!k) return NextResponse.json({error:'Missing env'},{status:500}); const stripe=new Stripe(key,{apiVersion:'2024-06-20' as any}); const sig=req.headers.get('stripe-signature') as string; const buf=await req.text(); let event; try{ event=stripe.webhooks.constructEvent(buf,sig,secret);}catch(e:any){ return NextResponse.json({error:`Webhook error: ${e.message}`},{status:400}); } if(event.type==='checkout.session.completed'){ const session=event.data.object as any; const id=session?.metadata?.booking_id; if(id){ const s=createClient(url,k); await s.from('bookings').update({status:'confirmed', payment_intent_id: session.payment_intent}).eq('id',id); } } return NextResponse.json({received:true}); } export const config={api:{bodyParser:false}} as any;